<div class="historial-container" *ngIf="!loading">
    <div class="historial-card">
        <!-- HEADER -->
        <div class="historial-header">
            <h3>{{ cliente?.nombres }} {{ cliente?.apellidos }} - Historia Clínica</h3>
        </div>

        <!-- BODY -->
        <form [formGroup]="clienteForm" class="cliente-form-section">
            <!-- INFORMACIÓN PERSONAL -->
            <div class="section-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-contact-icon lucide-contact"><path d="M16 2v2"/><path d="M7 22v-2a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v2"/><path d="M8 2v2"/><circle cx="12" cy="11" r="3"/><rect x="3" y="4" width="18" height="18" rx="2"/></svg>
                <h4 style="margin-left: 3px;"> Información Personal</h4>
            </div>

            <div class="cliente-grid">
                <div class="input-group">
                    <label>Nombres *</label>
                    <input type="text" formControlName="nombres" placeholder="Ej: Juan Carlos" appEnterNext>
                    <span class="error-msg" *ngIf="esInvalidoCliente('nombres')">
            {{ getMensajeErrorCliente('nombres') }}
          </span>
                </div>

                <div class="input-group">
                    <label>Apellidos *</label>
                    <input type="text" formControlName="apellidos" placeholder="Ej: Pérez García" appEnterNext>
                    <span class="error-msg" *ngIf="esInvalidoCliente('apellidos')">
            {{ getMensajeErrorCliente('apellidos') }}
          </span>
                </div>

                <div class="input-group">
                    <label>Cédula *</label>
                    <input type="text" formControlName="cedula" placeholder="1234567890" maxlength="10" appEnterNext>
                    <span class="error-msg" *ngIf="esInvalidoCliente('cedula')">
            {{ getMensajeErrorCliente('cedula') }}
          </span>
                </div>

                <div class="input-group">
                    <label>Teléfono *</label>
                    <input type="text" formControlName="telefono" placeholder="0987654321" maxlength="10" appEnterNext>
                    <span class="error-msg" *ngIf="esInvalidoCliente('telefono')">
            {{ getMensajeErrorCliente('telefono') }}
          </span>
                </div>

                <div class="input-group">
                    <label>Email</label>
                    <input type="email" formControlName="email" placeholder="ejemplo@correo.com" appEnterNext>
                    <span class="error-msg" *ngIf="esInvalidoCliente('email')">
            {{ getMensajeErrorCliente('email') }}
          </span>
                </div>

                <div class="input-group">
                    <label>País</label>
                    <input type="text" formControlName="pais" placeholder="Ecuador" appEnterNext>
                </div>

                <div class="input-group">
                    <label>Provincia</label>
                    <select formControlName="provincia" appEnterNext>
            <option value="">Seleccione una provincia</option>
            <option *ngFor="let prov of provinciasEcuador" [value]="prov">{{ prov }}</option>
          </select>
                </div>

                <div class="input-group">
                    <label>Ciudad</label>
                    <input type="text" formControlName="ciudad" placeholder="Ej: Quito" appEnterNext>
                </div>

                <div class="input-group full-width">
                    <label>Dirección</label>
                    <input type="text" formControlName="direccion" placeholder="Ej: Av. Principal 123 y Secundaria" appEnterNext>
                </div>
            </div>
        </form>


        <!-- HISTORIAL CLÍNICO -->
        <form [formGroup]="form" (ngSubmit)="guardar()">
            <div class="section-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard-clock-icon lucide-clipboard-clock"><path d="M16 14v2.2l1.6 1"/><path d="M16 4h2a2 2 0 0 1 2 2v.832"/><path d="M8 4H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h2"/><circle cx="16" cy="16" r="6"/><rect x="8" y="2" width="8" height="4" rx="1"/></svg>
                <h4 style="margin-left: 3px ;">Historial Clínico</h4>
            </div>


            <!-- OD / OI -->
            <div class="ojos-grid">
                <!-- OD -->
                <div class="ojo-card">
                    <h4>Ojo Derecho (OD)</h4>
                    <div class="ojo-inputs">
                        <div class="input-group">
                            <label>Esfera</label>
                            <input type="number" step="0.25" formControlName="odEsfera" appEnterNext>
                        </div>
                        <div class="input-group">
                            <label>Cilindro</label>
                            <input type="number" step="0.25" formControlName="odCilindro" appEnterNext>
                        </div>
                        <div class="input-group">
                            <label>Eje</label>
                            <input type="number" step="1" min="0" max="180" formControlName="odEje" appEnterNext>
                        </div>
                        <div class="input-group">
                            <label>AVSC</label>
                            <input type="text" formControlName="odAVSC" placeholder="20/29" appEnterNext>
                        </div>
                        <div class="input-group">
                            <label>AVCC</label>
                            <input type="text" formControlName="odAVCC" placeholder="20/40" appEnterNext>
                        </div>
                    </div>
                </div>

                <!-- OI -->
                <div class="ojo-card">
                    <h4>Ojo Izquierdo (OI)</h4>
                    <div class="ojo-inputs">
                        <div class="input-group">
                            <label>Esfera</label>
                            <input type="number" step="0.25" formControlName="oiEsfera" appEnterNext>
                        </div>
                        <div class="input-group">
                            <label>Cilindro</label>
                            <input type="number" step="0.25" formControlName="oiCilindro" appEnterNext>
                        </div>
                        <div class="input-group">
                            <label>Eje</label>
                            <input type="number" step="1" min="0" max="180" formControlName="oiEje" appEnterNext>
                        </div>
                        <div class="input-group">
                            <label>AVSC</label>
                            <input type="text" formControlName="oiAVSC" placeholder="20/29" appEnterNext>
                        </div>
                        <div class="input-group">
                            <label>AVCC</label>
                            <input type="text" formControlName="oiAVCC" placeholder="20/40" appEnterNext>
                        </div>
                    </div>
                </div>
            </div>
            <!-- MEDIDAS PRINCIPALES -->
            <div class="section-medidas">
                <div class="input-group">
                    <label>ADD</label>
                    <input type="number" step="0.25" formControlName="add" placeholder="2.00" appEnterNext>
                    <span class="error-msg" *ngIf="esInvalido('add')">
                        {{ getMensajeError('add') }}
                    </span>
                </div>
                <div class="input-group">
                    <label>DP</label>
                    <input type="number" step="0.5" formControlName="dp" placeholder="62" appEnterNext>
                    <span class="error-msg" *ngIf="esInvalido('dp')">
                        {{ getMensajeError('dp') }}
                    </span>
                </div>
                <div class="input-group">
                    <label>Altura</label>
                    <input type="number" step="0.1" formControlName="altura" placeholder="18.5" appEnterNext>
                    <span class="error-msg" *ngIf="esInvalido('altura')">
                        {{ getMensajeError('altura') }}
                    </span>
                </div>
            </div>

            <!-- SECCIÓN: MEDIDAS DEL ARMAZÓN -->
            <div class="section-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-glasses"><circle cx="6" cy="15" r="4"/><circle cx="18" cy="15" r="4"/><path d="M6 11V9a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v2"/></svg>
                <h4 style="margin-left: 3px;">Medidas del Armazón</h4>
            </div>

            <div class="armazon-grid">
                <div class="input-group">
                    <label>H (Ancho del Aro) *</label>
                    <input type="number" step="0.1" formControlName="armazonH" placeholder="52" appEnterNext>
                    <span class="error-msg" *ngIf="esInvalido('armazonH')">
                        {{ getMensajeError('armazonH') }}
                    </span>
                </div>
                <div class="input-group">
                    <label>V (Alto del Aro) *</label>
                    <input type="number" step="0.1" formControlName="armazonV" placeholder="40" appEnterNext>
                    <span class="error-msg" *ngIf="esInvalido('armazonV')">
                        {{ getMensajeError('armazonV') }}
                    </span>
                </div>
                <div class="input-group">
                    <label>DM (Diagonal Mayor) *</label>
                    <input type="number" step="0.1" formControlName="armazonDM" placeholder="60" appEnterNext>
                    <span class="error-msg" *ngIf="esInvalido('armazonDM')">
                        {{ getMensajeError('armazonDM') }}
                    </span>
                </div>
                <div class="input-group">
                    <label>P (Puente) *</label>
                    <input type="number" step="0.1" formControlName="armazonP" placeholder="18" appEnterNext>
                    <span class="error-msg" *ngIf="esInvalido('armazonP')">
                        {{ getMensajeError('armazonP') }}
                    </span>
                </div>
                <div class="input-group">
                    <label>Tipo de Armazón *</label>
                    <select formControlName="armazonTipo" appEnterNext>
                        <option value="">Seleccione tipo</option>
                        <option value="Completo">Completo</option>
                        <option value="Ranurado">Ranurado</option>
                        <option value="Al Aire">Al Aire</option>
                    </select>
                    <span class="error-msg" *ngIf="esInvalido('armazonTipo')">
                        {{ getMensajeError('armazonTipo') }}
                    </span>
                </div>
                <div class="input-group">
                    <label>DNP OD (Derecha) *</label>
                    <input type="number" step="0.5" formControlName="armazonDNP_OD" placeholder="31" appEnterNext>
                    <span class="error-msg" *ngIf="esInvalido('armazonDNP_OD')">
                        {{ getMensajeError('armazonDNP_OD') }}
                    </span>
                </div>
                <div class="input-group">
                    <label>DNP OI (Izquierda) *</label>
                    <input type="number" step="0.5" formControlName="armazonDNP_OI" placeholder="31" appEnterNext>
                    <span class="error-msg" *ngIf="esInvalido('armazonDNP_OI')">
                        {{ getMensajeError('armazonDNP_OI') }}
                    </span>
                </div>
                <div class="input-group">
                    <label>Altura (Alt) *</label>
                    <input type="number" step="0.1" formControlName="armazonAltura" placeholder="20" appEnterNext>
                    <span class="error-msg" *ngIf="esInvalido('armazonAltura')">
                        {{ getMensajeError('armazonAltura') }}
                    </span>
                </div>
            </div>


            <!-- EXTRA -->
            <div class="section-extra">
                <div class="input-group">
                    <label>De *</label>
                    <input type="text" formControlName="de" placeholder="Cerca / Lejos / DP" appEnterNext>
                    <span class="error-msg" *ngIf="esInvalido('de')">
                        {{ getMensajeError('de') }}
                    </span>
                </div>
                <div class="input-group">
                    <label>Color *</label>
                    <input type="text" formControlName="color" placeholder="Negro / Transparente" appEnterNext>
                    <span class="error-msg" *ngIf="esInvalido('color')">
                        {{ getMensajeError('color') }}
                    </span>
                </div>
            </div>

            <!-- OBSERVACIÓN -->
            <div class="section-observacion">
                <label>Observación</label>
                <textarea rows="3" formControlName="observacion" placeholder="Notas adicionales..." appEnterNext></textarea>
                <span class="error-msg" *ngIf="esInvalido('observacion')">
                    {{ getMensajeError('observacion') }}
                </span>
            </div>
            <div class="section-title">
                <h4>Doctor que atendió *</h4>
            </div>

            <div class="cliente-grid">
                <div class="input-group full-width">
                    <label>DR. *</label>
                    <input type="text" formControlName="doctor" placeholder="Ej: Dr. Juan Pérez" appEnterNext />
                    <span class="error-msg" *ngIf="esInvalido('doctor')">
                        {{ getMensajeError('doctor') }}
                    </span>
                </div>
            </div>


            <!-- FOOTER -->
            <div class="historial-footer">
                <button type="button" class="btn-cancel" (click)="cancelar()">
          Cancelar
        </button>
                <button type="submit" class="btn-save">
          Guardar Todo
        </button>
            </div>
        </form>
    </div>
</div>