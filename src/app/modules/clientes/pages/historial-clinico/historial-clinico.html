<div class="hc-wrapper">
  <div class="card">

    <!-- HEADER -->
    <div class="card-header">
      <div class="header-content">
        <h3 class="card-title">Historial Clínico</h3>

        <!-- Search -->
        <div class="search-wrapper">
          <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
               viewBox="0 0 24 24" fill="none" stroke="currentColor"
               stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>

          <input
            type="text"
            class="search-input"
            placeholder="Buscar cliente por nombre, cédula o teléfono..."
            [(ngModel)]="terminoBusqueda"
            (input)="buscarClientes()"
          />

          <button *ngIf="terminoBusqueda" class="clear-btn" (click)="limpiarBusqueda()" title="Limpiar búsqueda">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                 viewBox="0 0 24 24" fill="none" stroke="currentColor"
                 stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>

        <!-- Actions -->
        <div class="d-flex gap-2">
          <button class="btn btn-primary" (click)="crearCliente()">
            + Nuevo Cliente
          </button>
        </div>
      </div>

      <div class="search-results" *ngIf="terminoBusqueda">
        <span class="text-muted">{{ totalClientes }} resultado(s) encontrado(s)</span>
      </div>
    </div>

    <!-- BODY -->
    <div class="card-body">
      <div class="table-responsive">

        <table class="table" *ngIf="totalClientes > 0; else emptyState">
          <thead>
            <tr>
              <th>Cliente</th>
              <th>Cédula</th>
              <th>Teléfono</th>
              <th>Estado Historial</th>
              <th>Acciones</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let c of clientesFiltrados; trackBy: trackByClienteId">
              <td><strong>{{ c.nombres }} {{ c.apellidos }}</strong></td>
              <td>{{ c.cedula || '-' }}</td>
              <td>{{ c.telefono || '-' }}</td>

              <td>
                <span class="badge"
                      [class.badge-success]="c.tieneHistorial"
                      [class.badge-danger]="!c.tieneHistorial">
                  {{ c.tieneHistorial ? 'Con historial' : 'Sin historial' }}
                </span>
              </td>

              <td>
                <div class="d-flex gap-2">

                  <!-- Si tiene historial => Abrir -->
                  <button
                    *ngIf="c.tieneHistorial; else btnCrear"
                    class="btn btn-sm btn-primary"
                    (click)="abrirHistorial(c.id)">
                    Abrir
                  </button>

                  <!-- Si NO tiene historial => Crear -->
                  <ng-template #btnCrear>
                    <button
                      class="btn btn-sm btn-success"
                      (click)="crearHistorial(c.id)">
                      Crear
                    </button>
                  </ng-template>

                  <!-- Editar (solo si tiene historial) -->
                  <button
                    class="btn btn-sm btn-secondary"
                    [disabled]="!c.tieneHistorial"
                    (click)="editarHistorial(c.id)">
                    Editar
                  </button>

                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <ng-template #emptyState>
          <div class="text-center p-4">
            <p class="text-muted">No hay clientes para mostrar</p>
            <button class="btn btn-primary mt-3" (click)="crearCliente()">
              Crear Primer Cliente
            </button>
          </div>
        </ng-template>

      </div>
    </div>

  </div>
</div>
