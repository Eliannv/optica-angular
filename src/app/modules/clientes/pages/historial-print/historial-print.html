<div *ngIf="!loading && historial && cliente" class="ticket">

    <div class="t-center t-bold">ÓPTICA MACÍAS</div>
    <div class="t-center t-small">Historial Clínico</div>
    <div class="t-center t-small">Pasaje - Ecuador</div>

    <div class="t-hr"></div>

    <!-- Datos del cliente -->
    <div class="t-small">
        <div><b>Cliente:</b> {{ cliente.nombres }} {{ cliente.apellidos }}</div>
        <div><b>Cédula:</b> {{ cliente.cedula || '-' }}</div>
        <div><b>Tel:</b> {{ cliente.telefono || '-' }}</div>
        <div>
            <b>Fecha:</b> {{ cliente.createdAt?.toDate() | date:'dd/MM/yyyy HH:mm' }}
        </div>
    </div>

    <div class="t-hr"></div>

    <!-- Medidas -->
    <div class="t-bold t-small">MEDIDAS</div>

    <div class="t-small">
        <b>OD</b><br> Esf {{ formatValue(historial.odEsfera) }} Cil {{ formatValue(historial.odCilindro) }} Eje {{ formatValue(historial.odEje) }}<br> ACSV {{ formatValue(historial.odAVSC) }} AVCC {{ formatValue(historial.odAVCC) }}
    </div>


    <div class="t-small" style="margin-top:4px">
        <b>OI</b><br> Esf {{ formatValue(historial.oiEsfera) }} Cil {{ formatValue(historial.oiCilindro) }} Eje {{ formatValue(historial.oiEje) }}<br> ACSV {{ formatValue(historial.oiAVSC) }} AVCC {{ formatValue(historial.oiAVCC) }}
    </div>

    <div class="t-hr"></div>

    <!-- Medidas adicionales -->
    <div class="t-small" *ngIf="historial.add !== null && historial.add !== undefined">
        <b>ADD:</b> {{ historial.add | number:'1.2-2' }}
    </div>

    <div class="t-small" *ngIf="historial.dp !== null && historial.dp !== undefined">
        <b>DP:</b> {{ historial.dp | number:'1.2-2' }}
    </div>

    <div class="t-small" *ngIf="historial.altura !== null && historial.altura !== undefined">
        <b>Altura:</b> {{ historial.altura | number:'1.2-2' }} cm
    </div>

    <div class="t-small" *ngIf="historial.de">
        <b>DE:</b> {{ historial.de }}
    </div>

    <div class="t-small" *ngIf="historial.color">
        <b>Color:</b> {{ historial.color }}
    </div>

    <div class="t-hr"></div>

    <!-- MEDIDAS DEL ARMAZÓN (Solo si ADD > 0) -->
    <ng-container *ngIf="historial.add !== null && historial.add !== undefined && historial.add > 0">
        <div class="t-bold t-small">MEDIDAS DEL ARMAZÓN</div>

        <div class="t-small" style="margin-top:4px">
            <div *ngIf="historial.armazonH !== null && historial.armazonH !== undefined">
                <b>H (Ancho):</b> {{ historial.armazonH | number:'1.1-1' }} mm
            </div>
            <div *ngIf="historial.armazonV !== null && historial.armazonV !== undefined">
                <b>V (Alto):</b> {{ historial.armazonV | number:'1.1-1' }} mm
            </div>
            <div *ngIf="historial.armazonDM !== null && historial.armazonDM !== undefined">
                <b>DM (Diag. Mayor):</b> {{ historial.armazonDM | number:'1.1-1' }} mm
            </div>
            <div *ngIf="historial.armazonP !== null && historial.armazonP !== undefined">
                <b>P (Puente):</b> {{ historial.armazonP | number:'1.1-1' }} mm
            </div>
            <div *ngIf="historial.armazonTipo">
                <b>Tipo:</b> {{ historial.armazonTipo }}
            </div>
        </div>

        <div class="t-hr"></div>
    </ng-container>

    <!-- Observaciones -->
    <div class="t-small" *ngIf="historial.observacion">
        <b>Obs:</b><br> {{ historial.observacion }}
    </div>

    <div class="t-hr"></div>

    <!-- Información de registro -->
    <div class="t-small">
        <div *ngIf="historial.doctor">
            <b>Doctor:</b> {{ historial.doctor }}
        </div>
        <div>
            <b>Registro:</b> {{ historial.createdAt?.toDate() | date:'dd/MM/yyyy HH:mm' }}
        </div>
    </div>

    <div class="t-hr"></div>

    <!-- INFORMACIÓN DE FACTURAS -->
    <div *ngIf="facturas && facturas.length > 0 && obtenerUltimaFactura()">
        <div class="t-bold t-small">FACTURA MÁS RECIENTE</div>

        <div class="t-small" style="margin-bottom: 12px;">
            <div><b>Fac:</b> {{ obtenerUltimaFactura().id || '-' }}</div>
            <div><b>Total:</b> ${{ obtenerUltimaFactura().total | number:'1.2-2' }}</div>
            <div><b>Abono:</b> ${{ obtenerUltimaFactura().abonado | number:'1.2-2' }}</div>
            <div><b>Restante:</b> ${{ calcularTotalRestante(obtenerUltimaFactura()) | number:'1.2-2' }}</div>
            <div *ngIf="tieneArmazon(obtenerUltimaFactura())" style="color: #333; margin-top: 4px;">
                ✓ Armazón Incluido
            </div>
            <div *ngIf="!tieneArmazon(obtenerUltimaFactura())" style="color: #666; margin-top: 4px;">
                - Armazón Propio
            </div>
        </div>
    </div>

    <div class="t-hr"></div>

    <div class="t-center t-small">Documento informativo</div>
    <div class="t-center t-small">No válido como factura</div>

</div>