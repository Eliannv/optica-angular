<div class="form-container">
    <div class="form-card">
        <div class="form-header">
            <h1 class="form-title">Registrar Movimiento</h1>
            <button class="btn-secondary" (click)="volver()">← Volver</button>
        </div>

        <div class="form-body">
            <form [formGroup]="formulario" (ngSubmit)="guardarMovimiento()">
                <div class="form-group">
                    <label for="tipo">Tipo de Movimiento</label>
                    <select id="tipo" formControlName="tipo" class="form-control">
            <option value="INGRESO">Ingreso</option>
            <option value="EGRESO">Egreso</option>
          </select>
                </div>

                <div class="form-group">
                    <label for="categoria">Categoría</label>
                    <select id="categoria" formControlName="categoria" class="form-control">
            <option *ngFor="let cat of categorias_actuales" [value]="cat">
              {{ cat | lowercase }}
            </option>
          </select>
                </div>

                <!-- BÚSQUEDA DE CLIENTE/TRABAJADOR/PROVEEDOR (con datalist) -->
                <div class="form-group" *ngIf="mostrarBusquedaCliente()">
                    <label>
                        <span *ngIf="formulario.get('tipo')?.value === 'INGRESO'">Cliente (Transferencia)</span>
                        <span *ngIf="formulario.get('tipo')?.value === 'EGRESO' && formulario.get('categoria')?.value === 'PAGO_TRABAJADOR'">Trabajador (Pago)</span>
                        <span *ngIf="formulario.get('tipo')?.value === 'EGRESO' && formulario.get('categoria')?.value === 'PAGO_PROVEEDORES'">Proveedor (Pago)</span>
                    </label>
                    <input
                        type="text"
                        [(ngModel)]="busquedaCliente"
                        (ngModelChange)="buscarCliente()"
                        (blur)="onBlurSeleccionPersona()"
                        [ngModelOptions]="{standalone: true}"
                        placeholder="Escribe cédula, nombre, RUC o código..."
                        class="form-control"
                        list="personasList"
                    />
                    <datalist id="personasList">
                        <option
                            *ngFor="let p of personasBusqueda"
                            [value]="p.codigo || p.cedula || p.ruc || p.id" 
                            [attr.label]="((p.nombres || p.nombre || '') + ' ' + (p.apellidos || p.apellido || ''))"
                            [title]="((p.nombres || p.nombre || '') + ' ' + (p.apellidos || p.apellido || ''))"
                        ></option>
                    </datalist>
                    <div class="selected-item" *ngIf="formulario.get('categoria')?.value === 'PAGO_PROVEEDORES' && proveedorSeleccionado">
                        ✓ {{ proveedorSeleccionado.nombre }} (Código: {{ proveedorSeleccionado.codigo || 'N/A' }} | RUC: {{ proveedorSeleccionado.ruc || 'N/A' }})
                    </div>
                    <div class="selected-item" *ngIf="formulario.get('categoria')?.value !== 'PAGO_PROVEEDORES' && clienteSeleccionado">
                        ✓ {{ clienteSeleccionado.nombres || clienteSeleccionado.nombre }} {{ clienteSeleccionado.apellidos || clienteSeleccionado.apellido || '' }} ({{ clienteSeleccionado.cedula || clienteSeleccionado.id }})
                    </div>
                </div>

                <!-- INFORMACIÓN DE DEUDA PARA PAGO DE PROVEEDORES -->
                <div class="carrito-totales" *ngIf="formulario.get('tipo')?.value === 'EGRESO' && formulario.get('categoria')?.value === 'PAGO_PROVEEDORES' && proveedorSeleccionado">
                    <div class="total-row">
                        <span>Deuda Actual</span>
                        <strong>${{ deudaActual | number:'1.2-2' }}</strong>
                    </div>

                    <div class="total-row">
                        <span>Monto a Pagar</span>
                        <strong>${{ formulario.get('monto')?.value | number:'1.2-2' }}</strong>
                    </div>

                    <div class="total-row total-final">
                        <span>Deuda Restante</span>
                        <strong>${{ deudaRestante | number:'1.2-2' }}</strong>
                    </div>
                </div>

                <div class="form-group">
                    <label for="descripcion">Descripción</label>
                    <input id="descripcion" type="text" formControlName="descripcion" placeholder="Ej: Transferencia cliente Juan" class="form-control" [class.is-invalid]="formulario.get('descripcion')?.touched && formulario.get('descripcion')?.invalid" />
                    <small class="form-error" *ngIf="formulario.get('descripcion')?.touched && formulario.get('descripcion')?.invalid">
            Mínimo 5 caracteres
          </small>
                </div>

                <div class="form-group">
                    <label for="monto">Monto (USD)</label>
                    <input id="monto" type="number" formControlName="monto" placeholder="0.00" step="0.01" class="form-control" [class.is-invalid]="formulario.get('monto')?.touched && formulario.get('monto')?.invalid" />
                    <small class="form-error" *ngIf="formulario.get('monto')?.touched && formulario.get('monto')?.invalid">
            Ingresa un monto válido
          </small>
                </div>

                <div class="form-group">
                    <label for="referencia">Referencia (Código de transferencia, etc.)</label>
                    <input id="referencia" type="text" formControlName="referencia" placeholder="Ej: TRF-12345" class="form-control" />
                </div>

                <div class="form-actions">
                    <button type="submit" [disabled]="!formulario.valid || guardando" class="btn-primary">
            {{ guardando ? '⏳ Guardando...' : '✓ Guardar Movimiento' }}
          </button>
                </div>

                <div *ngIf="mensaje" class="alert" [ngClass]="mensaje.includes('✓') ? 'alert-success' : 'alert-danger'">
                    {{ mensaje }}
                </div>
            </form>
        </div>
    </div>
</div>