<div class="facturas-container">
    <div class="facturas-card">

        <!-- HEADER -->
        <div class="facturas-header">
            <div class="header-content">
                <h3 class="facturas-title">Facturas</h3>
                <button class="btn-primary" (click)="nuevaVenta()">
          <span>+ Nuevo</span>
        </button>
            </div>

            <!-- ‚úÖ NUEVO: Filtro por tipo -->
            <div class="search-container" style="margin-bottom: 0.75rem;">
                <label style="display:block; font-weight:600; font-size:0.85rem; margin-bottom:0.35rem; opacity:0.8;">
          Mostrar
        </label>
                <select class="search-input" [(ngModel)]="filtroEstado" (ngModelChange)="filtrar()">
          <option value="TODAS">üìã Todas</option>
          <option value="PENDIENTES">‚ö†Ô∏è Con deuda</option>
          <option value="PAGADAS">‚úÖ Finales</option>
        </select>
            </div>

            <div class="search-container">
                <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
                <input class="search-input" placeholder="Buscar por cliente, ID, m√©todo de pago..." [(ngModel)]="term" (input)="filtrar()">
                <button class="clear-btn" *ngIf="term" (click)="term = ''; filtrar()">‚úï</button>
            </div>
        </div>

        <!-- BODY -->
        <div class="facturas-body">

            <!-- TABLA DESKTOP -->
            <div class="table-wrapper desktop-only" *ngIf="totalFacturas > 0; else empty">
                <table class="facturas-table">
                    <thead>
                        <tr>
                            <th class="col-id">ID</th>
                            <th class="col-cliente">Cliente</th>
                            <th class="col-pago">M√©todo Pago</th>
                            <th class="col-total">Total</th>

                            <!-- ‚úÖ NUEVO -->
                            <th class="col-total">Estado</th>

                            <th class="col-acciones">Acciones</th>
                        </tr>
                    </thead>

                    <tbody>
                        <tr *ngFor="let f of facturasPaginadas" class="factura-row">
                            <td class="col-id">
                                <span class="badge-id">{{ f.idPersonalizado || f.id }}</span>
                            </td>

                            <td class="col-cliente">
                                <strong>{{ f.clienteNombre }}</strong>
                            </td>

                            <td class="col-pago">
                                <span class="badge-pago">{{ f.metodoPago }}</span>
                            </td>

                            <td class="col-total">
                                <span class="precio">${{ (Number(f.total) || 0).toFixed(2) }}</span>
                            </td>

                            <!-- ‚úÖ NUEVO: Estado + saldo -->
                            <td class="col-total">
                                <ng-container *ngIf="(Number(f.saldoPendiente) || 0) > 0; else pagada">
                                    <span class="badge badge-danger">Deuda</span>
                                    <div style="font-size: 0.82rem; opacity: 0.85; margin-top: 2px;">
                                        Saldo: <b>${{ (Number(f.saldoPendiente) || 0).toFixed(2) }}</b>
                                    </div>
                                </ng-container>

                                <ng-template #pagada>
                                    <span class="badge badge-success">Final</span>
                                </ng-template>
                            </td>

                            <td class="col-acciones">
                                <div class="action-buttons">
                                    <button class="btn-action btn-action-view" (click)="ver(f.id)" title="Ver detalles">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0"/><circle cx="12" cy="12" r="3"/></svg>
                    </button>

                                    <!-- ‚úÖ NUEVO: Cobrar deuda -->
                                    <button class="btn-action btn-action-payment" *ngIf="(Number(f.saldoPendiente) || 0) > 0" (click)="cobrarDeuda(f.clienteId, $event)" title="Cobrar deuda">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                            <path d="M16 11h-4"></path>
                        </svg>
                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- CARDS M√ìVIL -->
            <div class="mobile-cards mobile-only" *ngIf="totalFacturas > 0">
                <div class="factura-card-mobile" *ngFor="let f of facturasPaginadas">
                    <div class="card-mobile-header" (click)="ver(f.id)">
                        <span class="badge-id">{{ f.id }}</span>
                        <span class="badge-pago">{{ f.metodoPago }}</span>
                    </div>

                    <div class="card-mobile-body" (click)="ver(f.id)">
                        <div class="cliente-mobile">
                            <span class="label">Cliente</span>
                            <strong>{{ f.clienteNombre }}</strong>
                        </div>

                        <div class="total-mobile">
                            <span class="label">Total</span>
                            <span class="precio">${{ (Number(f.total) || 0).toFixed(2) }}</span>
                        </div>

                        <!-- ‚úÖ NUEVO: estado -->
                        <div class="total-mobile" style="margin-top: 6px;">
                            <span class="label">Estado</span>
                            <span *ngIf="(Number(f.saldoPendiente) || 0) > 0" class="badge badge-danger">
                Deuda ${{ (Number(f.saldoPendiente) || 0).toFixed(2) }}
              </span>
                            <span *ngIf="(Number(f.saldoPendiente) || 0) <= 0" class="badge badge-success">
                Final
              </span>
                        </div>
                    </div>

                    <div class="card-mobile-footer">
                        <div class="mobile-action-buttons">
                            <button class="btn-action btn-action-view" (click)="ver(f.id)" title="Ver detalles">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0"/><circle cx="12" cy="12" r="3"/></svg>
                                Ver detalles
                            </button>

                            <!-- ‚úÖ NUEVO: Cobrar deuda -->
                            <button class="btn-action-payment-mobile" *ngIf="(Number(f.saldoPendiente) || 0) > 0" (click)="cobrarDeuda(f.clienteId, $event)" title="Cobrar deuda">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                                    <path d="M16 11h-4"></path>
                                </svg>
                                Cobrar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controles de paginaci√≥n -->
            <div class="pagination-controls" *ngIf="totalFacturas > 0">
                <div class="pagination-info">
                    <span class="text-muted">
            Mostrando {{ (paginaActual - 1) * facturasPorPagina + 1 }} -
            {{ Math.min(paginaActual * facturasPorPagina, totalFacturas) }} de
            {{ totalFacturas }} facturas
          </span>
                </div>

                <div class="pagination-buttons">
                    <button class="btn-pagination" [disabled]="paginaActual === 1" (click)="paginaAnterior()">
            ‚Üê Anterior
          </button>
                    <button class="btn-pagination" [disabled]="paginaActual * facturasPorPagina >= totalFacturas" (click)="paginaSiguiente()">
            Siguiente ‚Üí
          </button>
                </div>
            </div>

            <!-- ESTADO VAC√çO -->
            <ng-template #empty>
                <div class="empty-state">
                    <div class="empty-icon">üìã</div>
                    <p>No hay facturas a√∫n</p>
                    <span>Crea tu primera venta para generar facturas</span>
                </div>
            </ng-template>

        </div>
    </div>
</div>