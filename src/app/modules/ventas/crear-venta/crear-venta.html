<!-- crear-venta.html -->

<!-- ‚úÖ ZONA NO IMPRIMIBLE (POS) -->
<div class="venta-container no-print" *ngIf="!loading">
    <div class="venta-card">
        <!-- HEADER -->
        <div class="venta-header">
            <div class="header-content">
                <h3 class="venta-title"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-piggy-bank-icon lucide-piggy-bank"><path d="M11 17h3v2a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1v-3a3.16 3.16 0 0 0 2-2h1a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1h-1a5 5 0 0 0-2-4V3a4 4 0 0 0-3.2 1.6l-.3.4H11a6 6 0 0 0-6 6v1a5 5 0 0 0 2 4v3a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1z"/><path d="M16 10h.01"/><path d="M2 8v1a2 2 0 0 0 2 2h1"/></svg>                    Punto de Venta (POS)</h3>
            </div>

            <div class="cliente-info">
                <div class="info-item">
                    <span class="info-label">Cliente:</span>
                    <span class="info-value">{{ cliente?.nombres }} {{ cliente?.apellidos }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Historial:</span>
                    <span class="badge" [class.badge-success]="historial" [class.badge-danger]="!historial">
            {{ historial ? '‚úì Disponible' : '‚úó No disponible' }}
          </span>
                </div>
            </div>
        </div>

        <!-- BODY -->
        <div class="venta-body">
            <!-- PRODUCTOS -->
            <div class="productos-section">
                <div class="section-header">
                    <h4>Buscar Productos</h4>
                </div>

                <div class="search-container">
                    <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
                    <input class="search-input" placeholder="Buscar por nombre, modelo, color, c√≥digo, ID interno... (usa ‚Üë‚Üì y Enter)" [(ngModel)]="filtro" (input)="filtrarProductos()" (keydown)="onSearchKeydown($event)" />
                    <button class="clear-btn" *ngIf="filtro" (click)="filtro = ''; filtrarProductos()">
            ‚úï
          </button>
                </div>

                <!-- Botones de ordenamiento -->
                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem;">
                    <button class="btn btn-sm btn-outline-secondary" (click)="cambiarOrdenamientoProductos('reciente')" [class.active]="ordenamientoProductos === 'reciente'" title="Ordenar por m√°s reciente" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-icon lucide-calendar"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg> Reciente
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" (click)="cambiarOrdenamientoProductos('codigo')" [class.active]="ordenamientoProductos === 'codigo'" title="Ordenar por c√≥digo (ID Interno)" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-asterisk-icon lucide-asterisk"><path d="M12 6v12"/><path d="M17.196 9 6.804 15"/><path d="m6.804 9 10.392 6"/></svg> C√≥digo
                    </button>
                </div>

                <!-- Lista de productos -->
                <div class="productos-list">
                    <button class="producto-item" type="button" *ngFor="let p of productosFiltrados; let i = index" [class.producto-selected]="i === selectedIndex" (click)="agregarProducto(p); filtro = ''; selectedIndex = -1;">
            <div class="producto-info">
              <div class="producto-nombre">{{ p.nombre }}</div>
              <div class="producto-detalles">
                <span class="detalle-badge"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-asterisk-icon lucide-asterisk"><path d="M12 6v12"/><path d="M17.196 9 6.804 15"/><path d="m6.804 9 10.392 6"/></svg> {{ p.idInterno }}</span>
                <span *ngIf="p.modelo" class="detalle-badge"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-box-icon lucide-box"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg> {{ p.modelo }}</span>
                <span *ngIf="p.color" class="detalle-badge"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-palette-icon lucide-palette"><path d="M12 22a1 1 0 0 1 0-20 10 9 0 0 1 10 9 5 5 0 0 1-5 5h-2.25a1.75 1.75 0 0 0-1.4 2.8l.3.4a1.75 1.75 0 0 1-1.4 2.8z"/><circle cx="13.5" cy="6.5" r=".5" fill="currentColor"/><circle cx="17.5" cy="10.5" r=".5" fill="currentColor"/><circle cx="6.5" cy="12.5" r=".5" fill="currentColor"/><circle cx="8.5" cy="7.5" r=".5" fill="currentColor"/></svg> {{ p.color }}</span>
              </div>
              <div class="producto-categoria">{{ p.tipo || p.categoria || p.grupo }}</div>
            </div>
            <div class="producto-precio">
              ${{ (p.pvp1 || p.costo || 0) | number:'1.2-2' }}
            </div>
          </button>

                    <div class="empty-state" *ngIf="!productosFiltrados.length">
                        <span>üîç No se encontraron productos</span>
                    </div>
                </div>
            </div>

            <!-- CARRITO -->
            <div class="carrito-section">
                <div class="section-header">
                    <h4>Carrito de Compras</h4>
                    <span class="items-count" *ngIf="items.length">{{ items.length }} item(s)</span>
                </div>

                <div class="carrito-content" *ngIf="items.length; else empty">
                    <div class="carrito-items">
                        <div class="carrito-item" *ngFor="let it of items">
                            <div class="item-info">
                                <div class="item-nombre">{{ $any(it).nombre }}</div>
                                <div class="item-tipo">{{ $any(it).tipo }}</div>
                            </div>

                            <div class="item-cantidad">
                                <label>Cant.</label>
                                <input type="number" min="1" [max]="it.stockDisponible" [ngModel]="it.cantidad" (ngModelChange)="cambiarCantidad(it, $event)" />
                                <span class="precio-unit">√ó ${{ it.precioUnitario.toFixed(2) }}</span>
                            </div>

                            <div class="item-total">
                                <div class="total-precio">${{ $any(it).total.toFixed(2) }}</div>
                                <button class="btn-remove" type="button" (click)="quitar(it)" title="Eliminar">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-icon lucide-trash"><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M3 6h18"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                </button>
                            </div>
                        </div>
                    </div>

                    <div class="carrito-totales">
                        <div class="total-row">
                            <span>Subtotal (bruto)</span>
                            <strong>${{ (subtotal + descuentoMonto).toFixed(2) }}</strong>
                        </div>

                        <!-- DESCUENTO -->
                        <div class="metodo-pago">
                            <label>Descuento (%)</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="number" min="0" max="100" class="search-input" [(ngModel)]="descuentoPorcentaje" (ngModelChange)="cambiarDescuento()" placeholder="0" style="flex: 1;" />
                                <span class="descuento-display"><strong>${{ descuentoMonto.toFixed(2) }}</strong></span>
                            </div>
                            <small class="muted">Descuento a aplicar sobre el subtotal</small>
                        </div>

                        <div class="total-row">
                            <span>Subtotal (neto)</span>
                            <strong>${{ subtotal.toFixed(2) }}</strong>
                        </div>
                        <div class="total-row" *ngIf="iva > 0">
                            <span>IVA (incluido en precios)</span>
                            <strong>${{ iva.toFixed(2) }}</strong>
                        </div>
                        <div class="total-row total-final">
                            <span>Total a Pagar</span>
                            <strong>${{ total.toFixed(2) }}</strong>
                        </div>

                        <div class="metodo-pago">
                            <label>M√©todo de Pago</label>
                            <select class="select-pago" [(ngModel)]="metodoPago">
                <option value="Efectivo">üíµ Efectivo</option>
                <option value="Transferencia">üè¶ Transferencia</option>
                <option value="Tarjeta">üí≥ Tarjeta</option>
              </select>
                        </div>

                        <!-- ‚úÖ C√ìDIGO DE TRANSFERENCIA (solo si es transferencia) -->
                        <div class="metodo-pago" *ngIf="metodoPago === 'Transferencia'">
                            <label>C√≥digo de Transferencia</label>
                            <input type="text" class="search-input" [(ngModel)]="codigoTransferencia" placeholder="Ej: TRF-20260112-001" />
                            <small class="muted">N√∫mero o referencia de la transferencia bancaria</small>
                        </div>

                        <!-- ‚úÖ √öLTIMOS 4 D√çGITOS DE TARJETA (solo si es tarjeta) -->
                        <div class="metodo-pago" *ngIf="metodoPago === 'Tarjeta'">
                            <label>√öltimos 4 D√≠gitos de la Tarjeta</label>
                            <input type="text" class="search-input" [(ngModel)]="ultimosCuatroTarjeta" placeholder="Ej: 1234" maxlength="4" />
                            <small class="muted">√öltimos 4 d√≠gitos de la tarjeta de cr√©dito/d√©bito</small>
                        </div>

                        <!-- ‚úÖ ABONO -->
                        <div class="metodo-pago">
                            <label>Abono (paga hoy)</label>
                            <input type="number" min="0" class="search-input" [(ngModel)]="abono" (ngModelChange)="recalcularAbono()" placeholder="0.00" />
                            <small class="muted">Si es menor al total, quedar√° saldo pendiente.</small>
                        </div>

                        <div class="total-row">
                            <span>Saldo pendiente</span>
                            <strong>${{ saldoPendiente.toFixed(2) }}</strong>
                        </div>

                        <div class="total-row" *ngIf="abono > total">
                            <span>Vuelto</span>
                            <strong style="color: #28a745;">${{ (abono - total).toFixed(2) }}</strong>
                        </div>

                        <!-- BOTONES DE ACCI√ìN -->
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn-secondary" type="button" (click)="volver()" style="flex: 1;">
                                <span>‚Üê Volver</span>
                            </button>
                            <button class="btn-primary" type="button" [disabled]="guardando || !items.length" (click)="guardarEImprimir()" style="flex: 1;">
                                <span>{{ guardando ? 'Guardando...' : 'Guardar + Imprimir' }}</span>
                            </button>
                        </div>
                    </div>
                </div>

                <ng-template #empty>
                    <div class="carrito-empty">
                        <div class="empty-icon">üõí</div>
                        <p>Tu carrito est√° vac√≠o</p>
                        <span>Agrega productos para generar la venta</span>
                    </div>
                </ng-template>
            </div>
        </div>
    </div>
</div>

<!-- ================= TICKET / FACTURA (oculto, solo para impresi√≥n) ================= -->
<div id="ticket" class="ticket" *ngIf="facturaParaImprimir">

    <div class="t-center t-bold">√ìPTICA MAC√çAS</div>
    <div class="t-center t-small">RUC: 0999999999001</div>
    <div class="t-center t-small">Machala - Ecuador</div>

    <div class="t-hr"></div>

    <div class="t-small">
        <div><b>FACTURA No:</b> {{ facturaParaImprimir.id }}</div>
        <div><b>Fecha:</b> {{ facturaParaImprimir.fecha | date:'dd/MM/yyyy HH:mm' }}</div>
        <div><b>Cliente:</b> {{ facturaParaImprimir.clienteNombre }}</div>
        <div><b>M√©todo pago:</b> {{ facturaParaImprimir.metodoPago }}</div>
    </div>

    <div class="t-hr"></div>

    <!-- TABLA -->
    <div class="t-table-head t-small">
        <span>COD</span>
        <span>DESCRIPCI√ìN</span>
        <span>CANT</span>
        <span>P.U</span>
        <span>P.T</span>
    </div>

    <div class="t-table-row t-small" *ngFor="let it of facturaParaImprimir.items; let i = index">
        <span class="t-cell">{{ it.codigo || it.productoId || i + 1 }}</span>
        <span class="t-cell t-cut">{{ it.nombre }}</span>
        <span class="t-cell t-right">{{ it.cantidad }}</span>
        <span class="t-cell t-right">{{ it.precioUnitario | number:'1.2-2' }}</span>
        <span class="t-cell t-right">{{ it.total | number:'1.2-2' }}</span>
    </div>

    <div class="t-hr"></div>

    <!-- TOTALES -->
    <div class="t-kv t-small">
        <span>Subtotal*</span>
        <span>{{ (facturaParaImprimir.subtotal + (facturaParaImprimir.descuentoMonto || 0)) | number:'1.2-2' }}</span>
    </div>
    <div class="t-kv t-small" *ngIf="facturaParaImprimir.descuentoMonto > 0">
        <span>Descuento ({{ facturaParaImprimir.descuentoPorcentaje }}%)</span>
        <span>-{{ facturaParaImprimir.descuentoMonto | number:'1.2-2' }}</span>
    </div>
    <div class="t-kv t-small">
        <span>Subtotal Neto</span>
        <span>{{ facturaParaImprimir.subtotal | number:'1.2-2' }}</span>
    </div>
    <div class="t-kv t-small" *ngIf="facturaParaImprimir.iva > 0">
        <span>IVA</span>
        <span>{{ facturaParaImprimir.iva | number:'1.2-2' }}</span>
    </div>
    <div class="t-kv t-bold">
        <span>TOTAL</span>
        <span>{{ facturaParaImprimir.total | number:'1.2-2' }}</span>
    </div>
    <div class="t-kv t-small" *ngIf="facturaParaImprimir.abonado > 0">
        <span>Abono</span>
        <span>{{ facturaParaImprimir.abonado | number:'1.2-2' }}</span>
    </div>
    <div class="t-kv t-small" *ngIf="facturaParaImprimir.saldoPendiente > 0">
        <span>Saldo pendiente</span>
        <span>{{ facturaParaImprimir.saldoPendiente | number:'1.2-2' }}</span>
    </div>
    <div class="t-kv t-small" *ngIf="facturaParaImprimir.abonado > facturaParaImprimir.total">
        <span>Vuelto</span>
        <span>{{ (facturaParaImprimir.abonado - facturaParaImprimir.total) | number:'1.2-2' }}</span>
    </div>

    <div class="t-hr"></div>
    <div class="t-center t-small">*IVA incluido en los precios</div>

    <div class="t-center t-small">Gracias por su compra</div>
    <div class="t-center t-small">Conserve su factura</div>

</div>