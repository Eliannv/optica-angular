<!-- crear-venta.html -->

<!-- ✅ ZONA NO IMPRIMIBLE (POS) -->
<div class="venta no-print" *ngIf="!loading">
  <div class="card">
    <div class="card-header">
      <div class="header">
        <h3>Ventas (POS)</h3>

        <div class="btns">
          <button class="btn btn-secondary" type="button" (click)="volver()">Volver</button>

          <button
            class="btn btn-primary"
            type="button"
            [disabled]="guardando || !items.length"
            (click)="guardarEImprimir()">
            {{ guardando ? 'Guardando...' : 'Guardar + Imprimir' }}
          </button>
        </div>
      </div>

      <div class="subheader">
        <div><strong>Cliente:</strong> {{ cliente?.nombres }} {{ cliente?.apellidos }}</div>
        <div class="muted">Historial: {{ historial ? 'OK' : 'No tiene' }}</div>
      </div>
    </div>

    <div class="card-body grid">
      <!-- Productos -->
      <div>
        <input
          class="search"
          placeholder="Buscar productos (marcos/lunas)..."
          [(ngModel)]="filtro"
          (input)="filtrarProductos()"
        />

        <div class="list">
          <button class="pitem" type="button" *ngFor="let p of productosFiltrados" (click)="agregarProducto(p)">
            <div>
              <div class="pname">{{ p.nombre }}</div>
              <div class="muted">{{ p.tipo || p.categoria }}</div>
            </div>
            <div class="price">
  ${{ (p.precios?.pvp1 || 0) | number:'1.2-2' }}
</div>

          </button>
        </div>
      </div>

      <!-- Carrito -->
      <div>
        <div class="cart" *ngIf="items.length; else empty">
          <div class="row" *ngFor="let it of items">
            <div class="w1">
              <div class="pname">{{ $any(it).nombre }}</div>
              <div class="muted">{{ $any(it).tipo }}</div>
            </div>

            <div class="w2">
              <input
                type="number"
                min="1"
                [ngModel]="it.cantidad"
                (ngModelChange)="cambiarCantidad(it, $event)"
              />
              <span class="muted">x ${{ it.precioUnitario.toFixed(2) }}</span>
            </div>

            <div class="w3">
              <strong>${{ $any(it).total.toFixed(2) }}</strong>
              <button class="btn btn-danger btn-sm" type="button" (click)="quitar(it)">X</button>
            </div>
          </div>

          <div class="tot">
            <div><span>Subtotal</span><strong>${{ subtotal.toFixed(2) }}</strong></div>
            <div><span>IVA</span><strong>${{ iva.toFixed(2) }}</strong></div>
            <div class="big"><span>Total</span><strong>${{ total.toFixed(2) }}</strong></div>

            <label class="muted">Método de pago</label>
            <select class="select" [(ngModel)]="metodoPago">
              <option>Efectivo</option>
              <option>Transferencia</option>
              <option>Tarjeta</option>
            </select>
          </div>
        </div>

        <ng-template #empty>
          <div class="muted">Agrega productos para generar la venta.</div>
        </ng-template>
      </div>
    </div>
  </div>
</div>

<!-- ================= TICKET / FACTURA ================= -->
<div class="ticket" *ngIf="facturaParaImprimir">

  <div class="t-center t-bold">ÓPTICA MACÍAS</div>
  <div class="t-center t-small">RUC: 0999999999001</div>
  <div class="t-center t-small">Machala - Ecuador</div>

  <div class="t-hr"></div>

  <div class="t-small">
    <div><b>FACTURA No:</b> {{ facturaParaImprimir.id }}</div>
    <div><b>Fecha:</b> {{ facturaParaImprimir.fecha | date:'dd/MM/yyyy HH:mm' }}</div>
    <div><b>Cliente:</b> {{ facturaParaImprimir.clienteNombre }}</div>
    <div><b>Método pago:</b> {{ facturaParaImprimir.metodoPago }}</div>
  </div>

  <div class="t-hr"></div>

  <!-- MEDIDAS -->
  <div class="t-bold t-small">MEDIDAS</div>
  <div class="t-small">
    OD: Esf {{ facturaParaImprimir.historialSnapshot?.odEsfera || '-' }}
    Cil {{ facturaParaImprimir.historialSnapshot?.odCilindro || '-' }}
    Eje {{ facturaParaImprimir.historialSnapshot?.odEje || '-' }}
  </div>
  <div class="t-small">
    OI: Esf {{ facturaParaImprimir.historialSnapshot?.oiEsfera || '-' }}
    Cil {{ facturaParaImprimir.historialSnapshot?.oiCilindro || '-' }}
    Eje {{ facturaParaImprimir.historialSnapshot?.oiEje || '-' }}
  </div>

  <div class="t-hr"></div>

  <!-- TABLA -->
  <div class="t-table-head t-small">
    <div>COD</div>
    <div>DESCRIPCIÓN</div>
    <div>CANT</div>
    <div>P.U</div>
    <div>TOTAL</div>
  </div>

  <div class="t-table-row t-small" *ngFor="let it of facturaParaImprimir.items; let i = index">
    <div>{{ i + 1 }}</div>
    <div class="t-cut">{{ it.nombre }}</div>
    <div>{{ it.cantidad }}</div>
    <div>{{ it.precioUnitario | number:'1.2-2' }}</div>
    <div>{{ it.total | number:'1.2-2' }}</div>
  </div>

  <div class="t-hr"></div>

  <!-- TOTALES -->
  <div class="t-kv t-small">
    <span>Subtotal</span>
    <span>{{ facturaParaImprimir.subtotal | number:'1.2-2' }}</span>
  </div>
  <div class="t-kv t-small">
    <span>IVA</span>
    <span>{{ facturaParaImprimir.iva | number:'1.2-2' }}</span>
  </div>
  <div class="t-kv t-bold">
    <span>TOTAL</span>
    <span>{{ facturaParaImprimir.total | number:'1.2-2' }}</span>
  </div>

  <div class="t-hr"></div>

  <div class="t-center t-small">Gracias por su compra</div>
  <div class="t-center t-small">Conserve su factura</div>

</div>
