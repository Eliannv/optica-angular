<!-- crear-venta.html -->

<!-- ‚úÖ ZONA NO IMPRIMIBLE (POS) -->
<div class="venta-container no-print" *ngIf="!loading">
    <div class="venta-card">
        <!-- HEADER -->
        <div class="venta-header">
            <div class="header-content">
                <h3 class="venta-title"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-piggy-bank-icon lucide-piggy-bank"><path d="M11 17h3v2a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1v-3a3.16 3.16 0 0 0 2-2h1a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1h-1a5 5 0 0 0-2-4V3a4 4 0 0 0-3.2 1.6l-.3.4H11a6 6 0 0 0-6 6v1a5 5 0 0 0 2 4v3a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1z"/><path d="M16 10h.01"/><path d="M2 8v1a2 2 0 0 0 2 2h1"/></svg>                    Punto de Venta (POS)</h3>
                <div class="header-actions">
                    <button class="btn-secondary" type="button" (click)="volver()">
            <span>‚Üê Volver</span>
          </button>
                    <button class="btn-primary" type="button" [disabled]="guardando || !items.length" (click)="guardarEImprimir()">
            <span>{{ guardando ? 'Guardando...' : 'Guardar + Imprimir' }}</span>
          </button>
                </div>
            </div>

            <div class="cliente-info">
                <div class="info-item">
                    <span class="info-label">Cliente:</span>
                    <span class="info-value">{{ cliente?.nombres }} {{ cliente?.apellidos }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Historial:</span>
                    <span class="badge" [class.badge-success]="historial" [class.badge-danger]="!historial">
            {{ historial ? '‚úì Disponible' : '‚úó No disponible' }}
          </span>
                </div>
            </div>
        </div>

        <!-- BODY -->
        <div class="venta-body">
            <!-- PRODUCTOS -->
            <div class="productos-section">
                <div class="section-header">
                    <h4>üõçÔ∏è Productos Disponibles</h4>
                </div>

                <div class="search-container">
                    <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
                    <input class="search-input" placeholder="Buscar productos por nombre, categor√≠a o tipo..." [(ngModel)]="filtro" (input)="filtrarProductos()" />
                    <button class="clear-btn" *ngIf="filtro" (click)="filtro = ''; filtrarProductos()">
            ‚úï
          </button>
                </div>

                <div class="productos-list">
                    <button class="producto-item" type="button" *ngFor="let p of productosFiltrados" (click)="agregarProducto(p)">
            <div class="producto-info">
              <div class="producto-nombre">{{ p.nombre }}</div>
              <div class="producto-categoria">{{ p.tipo || p.categoria }}</div>
            </div>
            <div class="producto-precio">
              ${{ (p.precios?.pvp1 || 0) | number:'1.2-2' }}
            </div>
          </button>

                    <div class="empty-state" *ngIf="!productosFiltrados.length">
                        <span>üîç No se encontraron productos</span>
                    </div>
                </div>
            </div>

            <!-- CARRITO -->
            <div class="carrito-section">
                <div class="section-header">
                    <h4>üõí Carrito de Compras</h4>
                    <span class="items-count" *ngIf="items.length">{{ items.length }} item(s)</span>
                </div>

                <div class="carrito-content" *ngIf="items.length; else empty">
                    <div class="carrito-items">
                        <div class="carrito-item" *ngFor="let it of items">
                            <div class="item-info">
                                <div class="item-nombre">{{ $any(it).nombre }}</div>
                                <div class="item-tipo">{{ $any(it).tipo }}</div>
                            </div>

                            <div class="item-cantidad">
                                <label>Cant.</label>
                                <input type="number" min="1" [ngModel]="it.cantidad" (ngModelChange)="cambiarCantidad(it, $event)" />
                                <span class="precio-unit">√ó ${{ it.precioUnitario.toFixed(2) }}</span>
                            </div>

                            <div class="item-total">
                                <div class="total-precio">${{ $any(it).total.toFixed(2) }}</div>
                                <button class="btn-remove" type="button" (click)="quitar(it)" title="Eliminar">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-icon lucide-trash"><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M3 6h18"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                </button>
                            </div>
                        </div>
                    </div>

                    <div class="carrito-totales">
                        <div class="total-row">
                            <span>Subtotal</span>
                            <strong>${{ subtotal.toFixed(2) }}</strong>
                        </div>
                        <div class="total-row">
                            <span>IVA (15%)</span>
                            <strong>${{ iva.toFixed(2) }}</strong>
                        </div>
                        <div class="total-row total-final">
                            <span>Total a Pagar</span>
                            <strong>${{ total.toFixed(2) }}</strong>
                        </div>

                        <div class="metodo-pago">
                            <label>M√©todo de Pago</label>
                            <select class="select-pago" [(ngModel)]="metodoPago">
                <option value="Efectivo">üíµ Efectivo</option>
                <option value="Transferencia">üè¶ Transferencia</option>
                <option value="Tarjeta">üí≥ Tarjeta</option>
              </select>
                        </div>
                        <!-- ‚úÖ ABONO -->
<div class="metodo-pago">
  <label>Abono (paga hoy)</label>
  <input
    type="number"
    min="0"
    class="search-input"
    [(ngModel)]="abono"
    (ngModelChange)="recalcularAbono()"
    placeholder="0.00"
  />
  <small class="muted">Si es menor al total, quedar√° saldo pendiente.</small>
</div>

<div class="total-row">
  <span>Saldo pendiente</span>
  <strong>${{ saldoPendiente.toFixed(2) }}</strong>
</div>
                    </div>
                </div>

                <ng-template #empty>
                    <div class="carrito-empty">
                        <div class="empty-icon">üõí</div>
                        <p>Tu carrito est√° vac√≠o</p>
                        <span>Agrega productos para generar la venta</span>
                    </div>
                </ng-template>
            </div>
        </div>
    </div>
</div>

<!-- ================= TICKET / FACTURA ================= -->
<div class="ticket" *ngIf="facturaParaImprimir">

    <div class="t-center t-bold">√ìPTICA MAC√çAS</div>
    <div class="t-center t-small">RUC: 0999999999001</div>
    <div class="t-center t-small">Machala - Ecuador</div>

    <div class="t-hr"></div>

    <div class="t-small">
        <div><b>FACTURA No:</b> {{ facturaParaImprimir.id }}</div>
        <div><b>Fecha:</b> {{ facturaParaImprimir.fecha | date:'dd/MM/yyyy HH:mm' }}</div>
        <div><b>Cliente:</b> {{ facturaParaImprimir.clienteNombre }}</div>
        <div><b>M√©todo pago:</b> {{ facturaParaImprimir.metodoPago }}</div>
    </div>

    <div class="t-hr"></div>

    <!-- TABLA -->
    <div class="t-table-head t-small">





    </div>

    <div class="t-table-row t-small" *ngFor="let it of facturaParaImprimir.items; let i = index">
      <div class="t-kv t-small">
        <span>COD</span>
        <span>{{ i + 1 }}</span>
    </div>
    <div class="t-kv t-small">
        <span>DESCRIPCI√ìN</span>
        <span class="t-cut">{{ it.nombre }}</span>
    </div>
    <div class="t-kv t-small">
        <span>CANT</span>
        <span>{{ it.cantidad }}</span>
    </div>
     <div class="t-kv t-small">
        <span>P.U</span>
        <span>{{ it.precioUnitario | number:'1.2-2' }}</span>
    </div>
    <div class="t-kv t-small">
        <span>P.T</span>
        <span>{{ it.total | number:'1.2-2' }}</span>
    </div>

    </div>

    <div class="t-hr"></div>

    <!-- TOTALES -->
    <div class="t-kv t-small">
        <span>Subtotal</span>
        <span>{{ facturaParaImprimir.subtotal | number:'1.2-2' }}</span>
    </div>
    <div class="t-kv t-small">
        <span>IVA</span>
        <span>{{ facturaParaImprimir.iva | number:'1.2-2' }}</span>
    </div>
    <div class="t-kv t-bold">
        <span>TOTAL</span>
        <span>{{ facturaParaImprimir.total | number:'1.2-2' }}</span>
    </div>
    <div class="t-kv t-small">
  <span>Abono</span>
  <span>{{ facturaParaImprimir.abonado | number:'1.2-2' }}</span>
</div>
<div class="t-kv t-small">
  <span>Saldo pendiente</span>
  <span>{{ facturaParaImprimir.saldoPendiente | number:'1.2-2' }}</span>
</div>


    <div class="t-hr"></div>

    <div class="t-center t-small">Gracias por su compra</div>
    <div class="t-center t-small">Conserve su factura</div>

</div>
