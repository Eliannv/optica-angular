<!-- ‚úÖ ZONA NO IMPRIMIBLE -->
<div class="venta-container no-print" *ngIf="!loading">
    <div class="venta-card">

        <!-- HEADER -->
        <div class="venta-header">
            <div class="header-content">
                <h3 class="venta-title">
                    Cobro de Deudas
                </h3>

                <div class="header-actions">
                    <button class="btn-volver" type="button" (click)="volver()">
            <span>‚Üê Volver</span>
          </button>
                </div>
            </div>

            <div class="cliente-info">
                <div class="info-item">
                    <span class="info-label">Cliente:</span>
                    <span class="info-value">{{ clienteNombre || '-' }}</span>
                </div>

                <div class="info-item">
                    <span class="info-label">Deuda total:</span>
                    <span class="badge badge-danger">
            ${{ deudaTotal.toFixed(2) }}
          </span>
                </div>
            </div>
        </div>

        <!-- BODY (misma grid que POS) -->
        <div class="venta-body">

            <!-- IZQUIERDA: Facturas pendientes -->
            <div class="productos-section">
                <div class="section-header">
                    <h4>Facturas Pendientes</h4>
                    <span class="items-count" *ngIf="pendientes.length">{{ pendientes.length }} pendiente(s)</span>
                </div>

                <!-- ‚úÖ B√öSQUEDA Y FILTROS -->
                <div class="search-container">
                    <svg class="search-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="6" cy="6" r="5"></circle>
                        <path d="m11 11 5 5"></path>
                    </svg>
                    <input 
                        type="text" 
                        class="search-input" 
                        [(ngModel)]="filtroFactura" 
                        (keydown)="onSearchKeydown($event)"
                        placeholder="Buscar por #factura..." />
                </div>

                <!-- FILTROS COLAPSABLES -->
                <div class="filters-row">
                    <div class="filter-item">
                        <label class="filter-label">Fecha:</label>
                        <input 
                            type="date" 
                            class="search-input filter-input" 
                            [(ngModel)]="filtroFecha" />
                    </div>

                    <div class="filter-item">
                        <label class="filter-label">Tipo:</label>
                        <select class="search-input filter-input" [(ngModel)]="filtroCredito">
                            <option value="todos">Todas</option>
                            <option value="conCredito">Con Cr√©dito</option>
                            <option value="sinCredito">Sin Cr√©dito</option>
                        </select>
                    </div>

                    <button 
                        class="btn-clear-all" 
                        type="button" 
                        *ngIf="filtroFactura || filtroFecha || filtroCredito !== 'todos'"
                        (click)="limpiarFiltros()"
                        title="Limpiar todos los filtros">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        Limpiar todo
                    </button>
                </div>

                <div class="empty-state" *ngIf="!pendientes.length">
                    <span>‚úÖ No hay deudas pendientes</span>
                </div>

                <div class="empty-state" *ngIf="pendientes.length && !facturasFiltradas.length">
                    <span>‚ùå No hay facturas que coincidan con los filtros</span>
                </div>

                <div class="productos-list" *ngIf="facturasFiltradas.length">
                    <button 
                        class="producto-item" 
                        type="button" 
                        *ngFor="let f of facturasFiltradas; let i = index" 
                        (click)="seleccionarFactura(f)"
                        [class.producto-selected]="selectedIndex === i">
            <div class="producto-info">
              <div class="producto-nombre">
                Factura #{{ f.id }}
                <!-- ‚úÖ INDICADOR DE CR√âDITO PERSONAL -->
                <span *ngIf="f.esCredito" style="display: inline-block; background-color: #ff9800; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 8px; font-weight: bold;">
                  üìã CR√âDITO
                </span>
              </div>
              <div class="producto-categoria">
                Fecha:
                <ng-container *ngIf="f.fecha?.toDate; else fechaNormal">
                  {{ f.fecha.toDate() | date:'dd/MM/yyyy HH:mm' }}
                </ng-container>
                <ng-template #fechaNormal>
                  {{ f.fecha | date:'dd/MM/yyyy HH:mm' }}
                </ng-template>
              </div>
              <div class="producto-categoria">
                Original: ${{ (f.total || 0) | number:'1.2-2' }}
              </div>
            </div>

            <div class="producto-precio">
              ${{ (f.saldoPendiente || 0) | number:'1.2-2' }}
            </div>
          </button>
                </div>
            </div>

            <!-- DERECHA: Panel de abono (estilo carrito) -->
            <div class="carrito-section">
                <div class="section-header">
                    <h4>Registrar Abono</h4>
                    <span class="items-count" *ngIf="facturaSeleccionada">1 seleccionada</span>
                </div>

                <!-- Si no ha elegido -->
                <div class="carrito-empty" *ngIf="!facturaSeleccionada">
                    <div class="empty-icon">üßæ</div>
                    <p>Selecciona una factura</p>
                    <span>Haz clic en una factura pendiente para cobrar</span>
                </div>

                <!-- Si eligi√≥ -->
                <div class="carrito-content" *ngIf="facturaSeleccionada">
                    <div class="carrito-items" style="max-height: 28vh;">
                        <div class="carrito-item">
                            <div class="item-info">
                                <div class="item-nombre">
                                    Factura #{{ facturaSeleccionada.id }}
                                    <!-- ‚úÖ INDICADOR DE CR√âDITO PERSONAL -->
                                    <span *ngIf="facturaSeleccionada.esCredito" style="display: inline-block; background-color: #ff9800; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 8px; font-weight: bold;">
                                        üìã CR√âDITO
                                    </span>
                                </div>
                                <div class="item-tipo">
                                    Total: ${{ (facturaSeleccionada.total || 0) | number:'1.2-2' }}
                                </div>
                                <div class="item-tipo">
                                    Abonado: ${{ (facturaSeleccionada.abonado || 0) | number:'1.2-2' }}
                                </div>
                                <div class="item-tipo">
                                    Saldo: <b>${{ (facturaSeleccionada.saldoPendiente || 0) | number:'1.2-2' }}</b>
                                </div>
                            </div>

                            <div class="item-cantidad">
                                <label class="form-label">Abono</label>
                                <div class="input-with-currency">
                                    <span class="currency-prefix">$</span>
                                    <input class="form-control input-with-prefix" type="number" min="0" max="{{ facturaSeleccionada.saldoPendiente || 0 }}" step="0.01" [ngModel]="abono" (ngModelChange)="onChangeAbono($event)" placeholder="0.00" />
                                </div>
                                <span class="max-amount-hint">
                  M√°x: ${{ (facturaSeleccionada.saldoPendiente || 0) | number:'1.2-2' }}
                </span>
                            </div>

                            <div class="item-total">

                                <button class="btn-guardar-abono" type="button" [disabled]="pagando || abono <= 0" (click)="registrarAbono()">
                  <span>{{ pagando ? 'Procesando...' : 'Guardar + Imprimir' }}</span>
                </button>
                            </div>
                        </div>
                    </div>

                    <div class="carrito-totales">
                        <div class="total-row">
                            <span>Saldo actual</span>
                            <strong>${{ (facturaSeleccionada.saldoPendiente || 0) | number:'1.2-2' }}</strong>
                        </div>

                        <div class="total-row">
                            <span>Abono</span>
                            <strong>${{ abono.toFixed(2) }}</strong>
                        </div>

                        <div class="total-row total-final">
                            <span>Saldo nuevo</span>
                            <strong>${{ saldoNuevo.toFixed(2) }}</strong>
                        </div>

                        <div class="total-row" *ngIf="abono > (facturaSeleccionada?.saldoPendiente || 0)">
                            <span>Vuelto</span>
                            <strong style="color: #28a745;">${{ (abono - (facturaSeleccionada?.saldoPendiente || 0)).toFixed(2) }}</strong>
                        </div>

                        <!-- ‚úÖ CR√âDITO PERSONAL - CONTROL SIEMPRE DISPONIBLE -->
                        <div class="metodo-pago" *ngIf="facturaSeleccionada">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin: 0; padding: 8px;">
                                <input type="checkbox" [(ngModel)]="esCreditoPersonal" style="width: 16px; height: 16px; cursor: pointer; flex-shrink: 0;" />
                                <span style="font-weight: 500; flex: 1;">üìã Cr√©dito Personal</span>
                                <span style="font-size: 11px; color: #999; white-space: nowrap;" *ngIf="esCreditoPersonal">
                                    {{saldoNuevo > 0 ? '(Activo)' : '(Cancelado)'}}
                                </span>
                            </label>
                        </div>

                        <div class="metodo-pago">
                            <label>M√©todo de Pago</label>
                            <select class="select-pago" [(ngModel)]="metodoPago">
                <option value="Efectivo">üíµ Efectivo</option>
                <option value="Transferencia">üè¶ Transferencia</option>
                <option value="Tarjeta">üí≥ Tarjeta</option>
              </select>
                        </div>

                        <!-- ‚úÖ C√ìDIGO DE TRANSFERENCIA (solo si es transferencia) -->
                        <div class="metodo-pago" *ngIf="metodoPago === 'Transferencia'">
                            <label>C√≥digo de Transferencia</label>
                            <input type="text" class="search-input" [(ngModel)]="codigoTransferencia" placeholder="Ej: TRF-20260112-001" />
                            <small class="muted">N√∫mero o referencia de la transferencia bancaria</small>
                        </div>

                        <!-- ‚úÖ √öLTIMOS 4 D√çGITOS DE TARJETA (solo si es tarjeta) -->
                        <div class="metodo-pago" *ngIf="metodoPago === 'Tarjeta'">
                            <label>√öltimos 4 D√≠gitos de la Tarjeta</label>
                            <input type="text" class="search-input" [(ngModel)]="ultimosCuatroTarjeta" placeholder="Ej: 1234" maxlength="4" />
                            <small class="muted">√öltimos 4 d√≠gitos de la tarjeta de cr√©dito/d√©bito</small>
                        </div>

                        <div class="total-row" *ngIf="saldoNuevo <= 0">
                            <span>Estado</span>
                            <strong class="badge badge-success">‚úÖ Pagada</strong>
                        </div>
                        <div class="total-row" *ngIf="saldoNuevo > 0">
                            <span>Estado</span>
                            <strong class="badge badge-danger">‚ö† Pendiente</strong>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>
</div>

<!-- ================= TICKET (COMPROBANTE ABONO) ================= -->
<div class="ticket" *ngIf="ticketPago">

    <div class="t-center t-bold">√ìPTICA MAC√çAS</div>
    <div class="t-center t-small">RUC: 0912477528001</div>
    <div class="t-center t-small">Pasaje - Ecuador</div>

    <div class="t-hr"></div>

    <!-- Detalle de productos -->
    <ng-container *ngIf="ticketPago.items?.length">
        <div class="t-table-head t-small">
            <span>COD</span>
            <span>NOMBRE</span>
            <span>CANT</span>
            <span>P.U</span>
            <span>P.T</span>
        </div>

        <div class="t-table-row t-small" *ngFor="let it of ticketPago.items">
            <span class="t-cell">{{ it.idInterno || it.codigo || it.productoId }}</span>
            <span class="t-cell t-cut">{{ it.nombre }}</span>
            <span class="t-cell t-right">{{ it.cantidad }}</span>
            <span class="t-cell t-right">{{ it.precioUnitario | number:'1.2-2' }}</span>
            <span class="t-cell t-right">{{ it.total | number:'1.2-2' }}</span>
        </div>

        <div class="t-hr"></div>
    </ng-container>

    <div class="t-small">
        <div><b>COMPROBANTE:</b> PAGO / ABONO</div>
        <div><b>FACTURA No:</b> {{ ticketPago.facturaId }}</div>
        <div><b>Fecha:</b> {{ ticketPago.fecha | date:'dd/MM/yyyy HH:mm' }}</div>
        <div><b>Cliente:</b> {{ ticketPago.clienteNombre }}</div>
        <div *ngIf="ticketPago.clienteTelefono"><b>Tel:</b> {{ ticketPago.clienteTelefono }}</div>
        <div><b>M√©todo pago:</b> {{ ticketPago.metodoPago }}</div>
        <div *ngIf="ticketPago.esCreditoPersonal">CR√âDITO PERSONAL</div>
    </div>

    <div class="t-hr"></div>

    <div class="t-kv t-small">
        <span>Total factura</span>
        <span>{{ ticketPago.totalFactura | number:'1.2-2' }}</span>
    </div>

    <div class="t-kv t-small">
        <span>Abonado anterior</span>
        <span>{{ ticketPago.abonadoAnterior | number:'1.2-2' }}</span>
    </div>

    <div class="t-kv t-small">
        <span>Abono realizado</span>
        <span>{{ ticketPago.abonoRealizado | number:'1.2-2' }}</span>
    </div>

    <div class="t-kv t-small">
        <span>Abonado total</span>
        <span>{{ ticketPago.abonadoNuevo | number:'1.2-2' }}</span>
    </div>

    <div class="t-hr"></div>

    <div class="t-kv t-bold">
        <span>SALDO</span>
        <span>{{ ticketPago.saldoNuevo | number:'1.2-2' }}</span>
    </div>

    <div class="t-center t-small" style="margin-top: 6px;">
        {{ ticketPago.saldoNuevo
        <=0 ? '‚úÖ DEUDA CANCELADA' : '‚ö†Ô∏è SALDO PENDIENTE' }} </div>

            <div class="t-hr"></div>

            <div class="t-center t-small">Gracias</div>
            <div class="t-center t-small">Conserve este comprobante</div>

    </div>