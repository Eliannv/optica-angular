<!-- ‚úÖ ZONA NO IMPRIMIBLE -->
<div class="venta-container no-print" *ngIf="!loading">
    <div class="venta-card">

        <!-- HEADER -->
        <div class="venta-header">
            <div class="header-content">
                <h3 class="venta-title">
                    Cobro de Deudas
                </h3>

                <div class="header-actions">
                    <button class="btn-volver" type="button" (click)="volver()">
            <span>‚Üê Volver</span>
          </button>
                </div>
            </div>

            <div class="cliente-info">
                <div class="info-item">
                    <span class="info-label">Cliente:</span>
                    <span class="info-value">{{ clienteNombre || '-' }}</span>
                </div>

                <div class="info-item">
                    <span class="info-label">Deuda total:</span>
                    <span class="badge badge-danger">
            ${{ deudaTotal.toFixed(2) }}
          </span>
                </div>
            </div>
        </div>

        <!-- BODY (misma grid que POS) -->
        <div class="venta-body">

            <!-- IZQUIERDA: Facturas pendientes -->
            <div class="productos-section">
                <div class="section-header">
                    <h4>Facturas Pendientes</h4>
                    <span class="items-count" *ngIf="pendientes.length">{{ pendientes.length }} pendiente(s)</span>
                </div>

                <div class="empty-state" *ngIf="!pendientes.length">
                    <span>‚úÖ No hay deudas pendientes</span>
                </div>

                <div class="productos-list" *ngIf="pendientes.length">
                    <button class="producto-item" type="button" *ngFor="let f of pendientes" (click)="seleccionarFactura(f)">
            <div class="producto-info">
              <div class="producto-nombre">Factura #{{ f.id }}</div>
              <div class="producto-categoria">
                Fecha:
                <ng-container *ngIf="f.fecha?.toDate; else fechaNormal">
                  {{ f.fecha.toDate() | date:'dd/MM/yyyy HH:mm' }}
                </ng-container>
                <ng-template #fechaNormal>
                  {{ f.fecha | date:'dd/MM/yyyy HH:mm' }}
                </ng-template>
              </div>
              <div class="producto-categoria">
                Abonado: ${{ (f.abonado || 0) | number:'1.2-2' }} | Saldo: <b>${{ (f.saldoPendiente || 0) | number:'1.2-2' }}</b>
              </div>
            </div>

            <div class="producto-precio">
              ${{ (f.total || 0) | number:'1.2-2' }}
            </div>
          </button>
                </div>
            </div>

            <!-- DERECHA: Panel de abono (estilo carrito) -->
            <div class="carrito-section">
                <div class="section-header">
                    <h4>Registrar Abono</h4>
                    <span class="items-count" *ngIf="facturaSeleccionada">1 seleccionada</span>
                </div>

                <!-- Si no ha elegido -->
                <div class="carrito-empty" *ngIf="!facturaSeleccionada">
                    <div class="empty-icon">üßæ</div>
                    <p>Selecciona una factura</p>
                    <span>Haz clic en una factura pendiente para cobrar</span>
                </div>

                <!-- Si eligi√≥ -->
                <div class="carrito-content" *ngIf="facturaSeleccionada">
                    <div class="carrito-items" style="max-height: 28vh;">
                        <div class="carrito-item">
                            <div class="item-info">
                                <div class="item-nombre">Factura #{{ facturaSeleccionada.id }}</div>
                                <div class="item-tipo">
                                    Total: ${{ (facturaSeleccionada.total || 0) | number:'1.2-2' }}
                                </div>
                                <div class="item-tipo">
                                    Abonado: ${{ (facturaSeleccionada.abonado || 0) | number:'1.2-2' }}
                                </div>
                                <div class="item-tipo">
                                    Saldo: <b>${{ (facturaSeleccionada.saldoPendiente || 0) | number:'1.2-2' }}</b>
                                </div>
                            </div>

                            <div class="item-cantidad">
                                <label class="form-label">Abono</label>
                                <div class="input-with-currency">
                                    <span class="currency-prefix">$</span>
                                    <input class="form-control input-with-prefix" type="number" min="0" max="{{ facturaSeleccionada.saldoPendiente || 0 }}" step="0.01" [ngModel]="abono" (ngModelChange)="onChangeAbono($event)" placeholder="0.00" />
                                </div>
                                <span class="max-amount-hint">
                  M√°x: ${{ (facturaSeleccionada.saldoPendiente || 0) | number:'1.2-2' }}
                </span>
                            </div>

                            <div class="item-total">

                                <button class="btn-guardar-abono" type="button" [disabled]="pagando || abono <= 0" (click)="registrarAbono()">
                  <span>{{ pagando ? 'Procesando...' : 'Guardar + Imprimir' }}</span>
                </button>
                            </div>
                        </div>
                    </div>

                    <div class="carrito-totales">
                        <div class="total-row">
                            <span>Saldo actual</span>
                            <strong>${{ (facturaSeleccionada.saldoPendiente || 0) | number:'1.2-2' }}</strong>
                        </div>

                        <div class="total-row">
                            <span>Abono</span>
                            <strong>${{ abono.toFixed(2) }}</strong>
                        </div>

                        <div class="total-row total-final">
                            <span>Saldo nuevo</span>
                            <strong>${{ saldoNuevo.toFixed(2) }}</strong>
                        </div>

                        <div class="metodo-pago">
                            <label>M√©todo de Pago</label>
                            <select class="select-pago" [(ngModel)]="metodoPago">
                <option value="Efectivo">üíµ Efectivo</option>
                <option value="Transferencia">üè¶ Transferencia</option>
                <option value="Tarjeta">üí≥ Tarjeta</option>
              </select>
                        </div>

                        <div class="total-row" *ngIf="saldoNuevo <= 0">
                            <span>Estado</span>
                            <strong class="badge badge-success">‚úÖ Pagada</strong>
                        </div>
                        <div class="total-row" *ngIf="saldoNuevo > 0">
                            <span>Estado</span>
                            <strong class="badge badge-danger">‚ö† Pendiente</strong>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>
</div>

<!-- ================= TICKET (COMPROBANTE ABONO) ================= -->
<div class="ticket" *ngIf="ticketPago">

    <div class="t-center t-bold">√ìPTICA MAC√çAS</div>
    <div class="t-center t-small">RUC: 0999999999001</div>
    <div class="t-center t-small">Machala - Ecuador</div>

    <div class="t-hr"></div>

    <!-- Detalle de productos -->
    <ng-container *ngIf="ticketPago.items?.length">
        <div class="t-table-head t-small">
            <span>COD</span>
            <span>DESCRIPCI√ìN</span>
            <span>CANT</span>
            <span>P.U</span>
            <span>P.T</span>
        </div>

        <div class="t-table-row t-small" *ngFor="let it of ticketPago.items">
            <span class="t-cell">{{ it.codigo || it.productoId }}</span>
            <span class="t-cell t-cut">{{ it.nombre }}</span>
            <span class="t-cell t-right">{{ it.cantidad }}</span>
            <span class="t-cell t-right">{{ it.precioUnitario | number:'1.2-2' }}</span>
            <span class="t-cell t-right">{{ it.total | number:'1.2-2' }}</span>
        </div>

        <div class="t-hr"></div>
    </ng-container>

    <div class="t-small">
        <div><b>COMPROBANTE:</b> PAGO / ABONO</div>
        <div><b>FACTURA No:</b> {{ ticketPago.facturaId }}</div>
        <div><b>Fecha:</b> {{ ticketPago.fecha | date:'dd/MM/yyyy HH:mm' }}</div>
        <div><b>Cliente:</b> {{ ticketPago.clienteNombre }}</div>
        <div><b>M√©todo pago:</b> {{ ticketPago.metodoPago }}</div>
    </div>

    <div class="t-hr"></div>

    <div class="t-kv t-small">
        <span>Total factura</span>
        <span>{{ ticketPago.totalFactura | number:'1.2-2' }}</span>
    </div>

    <div class="t-kv t-small">
        <span>Abonado anterior</span>
        <span>{{ ticketPago.abonadoAnterior | number:'1.2-2' }}</span>
    </div>

    <div class="t-kv t-small">
        <span>Abono realizado</span>
        <span>{{ ticketPago.abonoRealizado | number:'1.2-2' }}</span>
    </div>

    <div class="t-kv t-small">
        <span>Abonado total</span>
        <span>{{ ticketPago.abonadoNuevo | number:'1.2-2' }}</span>
    </div>

    <div class="t-hr"></div>

    <div class="t-kv t-bold">
        <span>SALDO</span>
        <span>{{ ticketPago.saldoNuevo | number:'1.2-2' }}</span>
    </div>

    <div class="t-center t-small" style="margin-top: 6px;">
        {{ ticketPago.saldoNuevo
        <=0 ? '‚úÖ DEUDA CANCELADA' : '‚ö†Ô∏è SALDO PENDIENTE' }} </div>

            <div class="t-hr"></div>

            <div class="t-center t-small">Gracias</div>
            <div class="t-center t-small">Conserve este comprobante</div>

    </div>