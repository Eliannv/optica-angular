<div class="container-fluid py-4">
    <!-- Header / Toolbar -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="toolbar card shadow-sm">
                <div class="toolbar-left">
                    <div class="title-wrap">
                        <h2 class="title">Administrar Empleados</h2>
                    </div>
                    <p class="subtitle">Gestiona el acceso, permisos y datos de tus empleados</p>
                </div>
                <div class="toolbar-right">
                    <div class="env-chip">
                        <span class="chip-label">Sucursal</span>
                        <span class="chip-value">{{ sucursalActual }}</span>
                    </div>
                    <div class="env-chip">
                        <span class="chip-label">Machine ID</span>
                        <code class="chip-code">{{ machineIdActual || 'N/A' }}</code>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="filters-container">
                <div class="search-wrapper">
                    <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <input type="text" class="search-input" placeholder="Buscar por nombre o email" [(ngModel)]="filtroNombre" (input)="aplicarFiltros()" />
                    <button *ngIf="filtroNombre" class="clear-btn" (click)="filtroNombre=''; aplicarFiltros()" title="Limpiar búsqueda">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>

                <div class="filter-pills">
                    <input type="radio" class="btn-check" name="filterEstado" id="fAll" [(ngModel)]="filtroEstado" [value]="'todos'" (change)="aplicarFiltros()">
                    <label class="filter-pill" for="fAll">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                        Todos
                    </label>

                    <input type="radio" class="btn-check" name="filterEstado" id="fAct" [(ngModel)]="filtroEstado" [value]="'activos'" (change)="aplicarFiltros()">
                    <label class="filter-pill filter-pill-success" for="fAct">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                        Activos
                    </label>

                    <input type="radio" class="btn-check" name="filterEstado" id="fInact" [(ngModel)]="filtroEstado" [value]="'inactivos'" (change)="aplicarFiltros()">
                    <label class="filter-pill filter-pill-danger" for="fInact">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
                        </svg>
                        Bloqueados
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div *ngIf="cargando" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2 text-muted">Cargando empleados...</p>
    </div>

    <!-- Error -->
    <div *ngIf="error" class="alert alert-danger">
        <strong>❌ Error:</strong> {{ error }}
    </div>

    <!-- Lista de Empleados -->
    <div *ngIf="!cargando && !error" class="row">
        <!-- Sin resultados -->
        <div *ngIf="empleadosFiltrados.length === 0" class="col-12">
            <div class="alert alert-info text-center">
                <p class="mb-0">No se encontraron empleados con los filtros seleccionados.</p>
            </div>
        </div>

        <!-- Tarjetas de Empleados -->
        <div *ngFor="let empleado of empleadosFiltrados" class="col-xl-4 col-lg-6 mb-4">
            <div class="card h-100 employee-card">
                <div class="card-body">
                    <!-- Header con avatar y estado -->
                    <div class="card-head d-flex align-items-start justify-content-between mb-2">
                        <div class="d-flex align-items-center gap-3">
                            <div class="avatar" [attr.title]="empleado.nombre">
                                {{ empleado.nombre.charAt(0) || '?' }}
                            </div>
                            <div>
                                <h5 class="card-title mb-0">{{ empleado.nombre }}</h5>
                                <small class="text-muted">{{ empleado.email }}</small>
                            </div>
                        </div>
                        <!-- Estado discreto para 'Sin acceso' -->
                        <small class="text-muted" *ngIf="getEstadoTexto(empleado) === 'Sin Acceso'">Sin Acceso</small>
                    </div>

                    <!-- Info -->
                    <div class="info-grid mb-3">
                        <div class="info-item">
                            <span class="info-label">Sucursal</span>
                            <span class="info-value">{{ empleado.sucursal || 'No asignada' }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Machine ID</span>
                            <span class="info-value">
                                <code *ngIf="empleado.machineId">{{ empleado.machineId }}</code>
                                <span *ngIf="!empleado.machineId" class="text-warning">No configurado</span>
                            </span>
                        </div>
                    </div>

                    <!-- Acciones -->
                    <div class="action-pills">
                        <button class="action-pill action-pill-primary" (click)="abrirModalEditar(empleado)" title="Editar datos">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                            </svg>
                            Editar
                        </button>

                        <button [ngClass]="empleado.activo ? 'action-pill-danger' : 'action-pill-success'" [class.active]="!empleado.activo" class="action-pill" (click)="toggleEstado(empleado)" [title]="empleado.activo ? 'Bloquear' : 'Desbloquear'">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                            </svg>
                            {{ empleado.activo ? 'Bloquear' : 'Desbloquear' }}
                        </button>
                    </div>
                </div>
                <div class="card-footer bg-transparent">
                    <small class="text-muted">Creado: {{ empleado.createdAt?.toDate?.() ? (empleado.createdAt.toDate() | date:'short') : 'N/A' }}</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Edición -->
<div class="modal-layer" *ngIf="modalAbierto" (click)="cerrarModal()">
    <div class="modal-card" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h5 class="modal-title">Editar Empleado</h5>
            <button type="button" class="btn-close" aria-label="Cerrar" (click)="cerrarModal()"></button>
        </div>
        <div class="modal-body" *ngIf="empleadoSeleccionado" [formGroup]="formEditar">
            <div class="form-group mb-3">
                <label class="form-label">Cédula <span class="text-danger">*</span></label>
                <input type="text" class="form-control" [class.is-invalid]="esInvalido('cedula')" [class.is-valid]="formEditar.get('cedula')?.valid && formEditar.get('cedula')?.touched" formControlName="cedula" placeholder="1234567890" maxlength="10" appEnterNext>
                <div class="form-text text-danger" *ngIf="esInvalido('cedula')">
                    {{ getMensajeError('cedula') }}
                </div>
            </div>

            <div class="form-group mb-3">
                <label class="form-label">Nombre <span class="text-danger">*</span></label>
                <input type="text" class="form-control" [class.is-invalid]="esInvalido('nombre')" [class.is-valid]="formEditar.get('nombre')?.valid && formEditar.get('nombre')?.touched" formControlName="nombre" placeholder="Juan" appEnterNext>
                <div class="form-text text-danger" *ngIf="esInvalido('nombre')">
                    {{ getMensajeError('nombre') }}
                </div>
            </div>

            <div class="form-group mb-3">
                <label class="form-label">Apellido <span class="text-danger">*</span></label>
                <input type="text" class="form-control" [class.is-invalid]="esInvalido('apellido')" [class.is-valid]="formEditar.get('apellido')?.valid && formEditar.get('apellido')?.touched" formControlName="apellido" placeholder="Pérez" appEnterNext>
                <div class="form-text text-danger" *ngIf="esInvalido('apellido')">
                    {{ getMensajeError('apellido') }}
                </div>
            </div>

            <div class="form-group mb-3">
                <label class="form-label">Fecha de nacimiento <span class="text-danger">*</span></label>
                <input type="date" class="form-control" [class.is-invalid]="esInvalido('fechaNacimiento')" [class.is-valid]="formEditar.get('fechaNacimiento')?.valid && formEditar.get('fechaNacimiento')?.touched" formControlName="fechaNacimiento" appEnterNext>
                <div class="form-text text-danger" *ngIf="esInvalido('fechaNacimiento')">
                    {{ getMensajeError('fechaNacimiento') }}
                </div>
            </div>

            <div class="form-group mb-3">
                <label class="form-label">Correo <span class="text-danger">*</span></label>
                <input type="email" class="form-control" [class.is-invalid]="esInvalido('email')" [class.is-valid]="formEditar.get('email')?.valid && formEditar.get('email')?.touched" formControlName="email" placeholder="ejemplo@optica.com" appEnterNext>
                <div class="form-text text-danger" *ngIf="esInvalido('email')">
                    {{ getMensajeError('email') }}
                </div>
            </div>

            <div class="form-text">
                <strong>Nota:</strong> La sucursal y el Machine ID se gestionan automáticamente desde la aplicación de escritorio.
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="cerrarModal()">Cancelar</button>
            <button type="button" class="btn btn-primary" (click)="guardarEdicion()" [disabled]="formEditar.invalid">Guardar cambios</button>
        </div>
    </div>
</div>