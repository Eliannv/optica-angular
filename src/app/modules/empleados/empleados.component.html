<div class="container-fluid py-4">
    <!-- Header / Toolbar -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="toolbar card shadow-sm">
                <div class="toolbar-left">
                    <div class="title-wrap">
                        <h2 class="title">Administrar Empleados</h2>
                    </div>
                    <p class="subtitle">Gestiona el acceso, permisos y datos de tus empleados</p>
                </div>
                <div class="toolbar-right">
                    <div class="env-chip">
                        <span class="chip-label">Sucursal</span>
                        <span class="chip-value">{{ sucursalActual }}</span>
                    </div>
                    <div class="env-chip">
                        <span class="chip-label">Machine ID</span>
                        <code class="chip-code">{{ machineIdActual || 'N/A' }}</code>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="row mb-3 g-3 align-items-center">
        <div class="col-lg-6">
            <div class="search-wrapper">
                <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <input type="text" class="search-input" placeholder="Buscar por nombre al empleado" [(ngModel)]="filtroNombre" (input)="aplicarFiltros()" />
                <button *ngIf="filtroNombre" class="clear-btn" (click)="filtroNombre=''; aplicarFiltros()" title="Limpiar búsqueda">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="filter-pills btn-group w-100" role="group">
                <input type="radio" class="btn-check" name="filterEstado" id="fAll" [(ngModel)]="filtroEstado" [value]="'todos'" (change)="aplicarFiltros()">
                <label class="btn btn-outline-primary" for="fAll">Todos</label>

                <input type="radio" class="btn-check" name="filterEstado" id="fAct" [(ngModel)]="filtroEstado" [value]="'activos'" (change)="aplicarFiltros()">
                <label class="btn btn-outline-success" for="fAct">Activos</label>

                <input type="radio" class="btn-check" name="filterEstado" id="fInact" [(ngModel)]="filtroEstado" [value]="'inactivos'" (change)="aplicarFiltros()">
                <label class="btn btn-outline-danger" for="fInact">Bloqueados</label>

                <input type="radio" class="btn-check" name="filterEstado" id="fNoAcc" [(ngModel)]="filtroEstado" [value]="'sinAcceso'" (change)="aplicarFiltros()">
                <label class="btn btn-outline-warning" for="fNoAcc">Sin acceso</label>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div *ngIf="cargando" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2 text-muted">Cargando empleados...</p>
    </div>

    <!-- Error -->
    <div *ngIf="error" class="alert alert-danger">
        <strong>❌ Error:</strong> {{ error }}
    </div>

    <!-- Lista de Empleados -->
    <div *ngIf="!cargando && !error" class="row">
        <!-- Sin resultados -->
        <div *ngIf="empleadosFiltrados.length === 0" class="col-12">
            <div class="alert alert-info text-center">
                <p class="mb-0">No se encontraron empleados con los filtros seleccionados.</p>
            </div>
        </div>

        <!-- Tarjetas de Empleados -->
        <div *ngFor="let empleado of empleadosFiltrados" class="col-xl-4 col-lg-6 mb-4">
            <div class="card h-100 employee-card">
                <div class="card-body">
                    <!-- Header con avatar y estado -->
                    <div class="card-head d-flex align-items-start justify-content-between mb-2">
                        <div class="d-flex align-items-center gap-3">
                            <div class="avatar" [attr.title]="empleado.nombre">
                                {{ empleado.nombre.charAt(0) || '?' }}
                            </div>
                            <div>
                                <h5 class="card-title mb-0">{{ empleado.nombre }}</h5>
                                <small class="text-muted">{{ empleado.email }}</small>
                            </div>
                        </div>
                        <!-- Estado sin cuadro naranja: mostrar texto discreto para 'Sin acceso' -->
                        <small class="text-muted" *ngIf="getEstadoTexto(empleado) === 'Sin acceso'">Sin Acceso</small>
                    </div>

                    <!-- Info -->
                    <div class="info-grid mb-3">
                        <div class="info-item">
                            <span class="info-label">Sucursal</span>
                            <span class="info-value">{{ empleado.sucursal || 'No asignada' }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Machine ID</span>
                            <span class="info-value">
                                <code *ngIf="empleado.machineId">{{ empleado.machineId }}</code>
                                <span *ngIf="!empleado.machineId" class="text-warning">No configurado</span>
                            </span>
                        </div>
                    </div>

                    <!-- Acciones -->
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-sm" [ngClass]="empleado.activo ? 'btn-outline-danger' : 'btn-outline-success'" (click)="toggleEstado(empleado)" [title]="empleado.activo ? 'Bloquear' : 'Desbloquear'">
                            {{ empleado.activo ? 'Bloquear' : 'Desbloquear' }}
                        </button>

                        <button class="btn btn-outline-primary btn-sm" (click)="abrirModalEditar(empleado)" title="Editar datos">
                            Editar
                        </button>

                        <button class="btn btn-outline-danger btn-sm" (click)="eliminarEmpleado(empleado)" title="Eliminar">
                            Eliminar
                        </button>
                    </div>
                </div>
                <div class="card-footer bg-transparent">
                    <small class="text-muted">Creado: {{ empleado.createdAt?.toDate?.() ? (empleado.createdAt.toDate() | date:'short') : 'N/A' }}</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Edición -->
<div class="modal-layer" *ngIf="modalAbierto" (click)="cerrarModal()">
    <div class="modal-card" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h5 class="modal-title">Editar Empleado</h5>
            <button type="button" class="btn-close" aria-label="Cerrar" (click)="cerrarModal()"></button>
        </div>
        <div class="modal-body" *ngIf="empleadoSeleccionado" [formGroup]="formEditar">
            <div class="form-group mb-3">
                <label class="form-label">Cédula</label>
                <input type="text" class="form-control" formControlName="cedula" placeholder="1234567890">
            </div>

            <div class="form-group mb-3">
                <label class="form-label">Nombre</label>
                <input type="text" class="form-control" formControlName="nombre" placeholder="Juan">
            </div>

            <div class="form-group mb-3">
                <label class="form-label">Apellido</label>
                <input type="text" class="form-control" formControlName="apellido" placeholder="Pérez">
            </div>

            <div class="form-group mb-3">
                <label class="form-label">Fecha de nacimiento</label>
                <input type="date" class="form-control" formControlName="fechaNacimiento" placeholder="dd/mm/aaaa">
            </div>

            <div class="form-group mb-3">
                <label class="form-label">Correo</label>
                <input type="email" class="form-control" formControlName="email" placeholder="ejemplo@optica.com">
            </div>

            <div class="form-text">
                Nota: La sucursal y el Machine ID se gestionan automáticamente desde la aplicación de escritorio.
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="cerrarModal()">Cancelar</button>
            <button type="button" class="btn btn-primary" (click)="guardarEdicion()">Guardar cambios</button>
        </div>
    </div>
</div>